/*! grace-conference-registration - v0.1.0 - * Copyright (c) 2013 Kai Yao <ohkaiby@gmail.com>; Licensed  */
(function(e,t,n,a,s,i,o){"use strict";var l=s||{};l.init={initialize:function(){var a;t.bindAll(l.init),i.models.question=n.Model.extend(l.questionsModelCore),i.app.questionCollection=new(n.Collection.extend(l.questionCollectionCore)),i.models.answer=n.Model.extend(l.answerModelCore),i.collections.answer=n.Collection.extend(l.answerCollectionCore),i.models.attendee=n.Model.extend(l.attendeeModelCore),i.app.attendeeCollection=new(n.Collection.extend(l.attendeeCollectionCore)),i.app.formView=new(n.View.extend(l.formViewCore))({collection:i.app.questionCollection}),i.app.reviewView=new(n.View.extend(l.reviewViewCore)),i.models.payment=n.Model.extend(l.paymentModelCore),i.app.paymentView=new(n.View.extend(l.paymentViewCore)),i.models.paymentProcessing=n.Model.extend(l.paymentProcessingModelCore),i.app.paymentProcessingModel=new i.models.paymentProcessing,i.app.completionView=new(n.View.extend(l.completionViewCore)),i.app.localstorage=new l.localStorageController,i.app.selected={},i.app.resetForm=this.resetForm,i.app.$view=e("#view-container"),this.fillQuestions(),this.fillSavedAttendeeAnswers(),(a=i.app.localstorage.load("invoice"))?e.get("/api/get/check_payment_made",{invoice:a}).done(function(e){e.paid?i.app.completionView.render():i.app.formView.render()}):i.app.formView.render()},fillQuestions:function(){var t,n=[{question_name:"number_of_attendees",question:"How many attendees are you registering for Grace 2013?",answer_type:"number_of_attendees",answers:[{name:"number_of_attendees",display:"# of attendees"}]},{question_name:"name",question:"What is your name?",answer_type:"text",answers:[{name:"first_name",display:"First Name"},{name:"last_name",display:"Last Name"}]},{question_name:"age",question:"How old are you?",display:"Age",answer_type:"radio",answers:[{name:"11",display:"11 and under"},{name:"12_17",display:"12 to 17 years old"},{name:"18",display:"18+ years old"}]},{question_name:"exact_age",question:"What is your EXACT age?",display:"Exact Age",answer_type:"text",answers:[{name:"exact_age",display:"Exact Age"}],depends_on:{question_name:"age",answer_names:["11"]}},{question_name:"gender",question:"You are…",display:"Gender",answer_type:"radio",answers:[{name:"male",display:"Male"},{name:"female",display:"Female"}]},{question_name:"grade",question:"What grade are you in?",display:"What grade",answer_type:"radio",answers:[{name:"5th",display:"5th grade"},{name:"6th",display:"6th grade"},{name:"7th",display:"7th grade"},{name:"8th",display:"8th grade"},{name:"freshmen",display:"Freshmen"},{name:"sophomore",display:"Sophomore"},{name:"junior",display:"Junior"},{name:"senior",display:"Senior"},{name:"freshmen_undergrad",display:"Freshmen (College)"},{name:"sophomore_undergrad",display:"Sophomore (College)"},{name:"junior_undergrad",display:"Junior (College)"},{name:"senior_undergrad",display:"Senior (College)"}],depends_on:{question_name:"age",answer_names:["12_17"]}},{question_name:"status",question:"You are… ?",display:"Status",answer_type:"radio",answers:[{name:"high_school_18",display:"In high school"},{name:"undergrad",display:"In college (undergrad)"},{name:"graduate",display:"In college (graduate)"},{name:"single",display:"Single"},{name:"married",display:"Married"}],depends_on:{question_name:"age",answer_names:["18"]}},{question_name:"undergrad_year",question:"What year in undergrad?",display:"College year",answer_type:"radio",answers:[{name:"1st",display:"First year"},{name:"2nd",display:"Second year"},{name:"3rd",display:"Third year"},{name:"4th",display:"Fourth year"},{name:"5th_plus",display:"Fifth+ year"}],depends_on:{question_name:"status",answer_names:["undergrad"]}},{question_name:"email",question:"What is your email?",answer_type:"email",answers:[{name:"email",display:"Email"}]},{question_name:"phone",question:"What’s your phone number?",answer_type:"phone",answers:[{name:"phone",display:"Phone"}]},{question_name:"phone_is_mobile",question:"Is this a cell phone number?",display:"Is cellphone",answer_type:"radio",answers:[{name:"yes",display:"Yes, it’s a cell phone"},{name:"no",display:"No, it’s not a cell phone"}]},{question_name:"address",question:"What is your address?",answer_type:"text",answers:[{name:"address",display:"Address"},{name:"city",display:"City"},{name:"state",display:"State"},{name:"zip",display:"Zip"}]},{question_name:"meal_plan",question:"Select the meals you would like prepared for you.",display:"Meals",answer_type:"meal_plan",answers:[{name:"meal_plan_day_1",display:"Thursday",date:"12/26/2013",meals:{breakfast:!1,lunch:!1,dinner:!0}},{name:"meal_plan_day_2",display:"Friday",date:"12/27/2013",meals:{breakfast:!0,lunch:!0,dinner:!0}},{name:"meal_plan_day_3",display:"Saturday",date:"12/28/2013",meals:{breakfast:!0,lunch:!0,dinner:!0}},{name:"meal_plan_day_4",display:"Sunday",date:"12/29/2013",meals:{breakfast:!0,lunch:!0,dinner:!0}},{name:"meal_plan_day_5",display:"Monday",date:"12/30/2013",meals:{breakfast:!0,lunch:!0,dinner:!1}}]},{question_name:"permission_slip",answer_type:"info",answers:[{html:e(document.createElement("div")).append(i.template("permission_slip")).html()}],depends_on:{question_name:"age",answer_names:["11","12_17"]}},{question_name:"hotel_code_of_conduct",question:"Please read & agree to the Pheasant Run Resort Code of Conduct.",display:"Agreed to Code of Conduct",answer_type:"agreement",answers:[]}];for(t=0;n.length>t;t++)i.app.questionCollection.add(new i.models.question(n[t]))},fillSavedAttendeeAnswers:function(){var e,t,n=i.app.localstorage.load("number_of_attendees");if(!n)return!1;for(e=0;n>e;e++)i.app.attendeeCollection.add(new i.models.attendee({storage_prefix:"attendee_"+e,all_questions_completed:i.app.localstorage.load("attendee_"+e+"."+"all_questions_completed")}));for(e=0;i.app.questionCollection.length>e;e++)for(t=0;i.app.attendeeCollection.length>t;t++)this.fillSavedAnswer(i.app.questionCollection.models[e].attributes,i.app.attendeeCollection.models[t]);i.app.attendeeCollection.fillLimboAnswers()},fillSavedAnswer:function(e,t){var n,a;if("text"===e.answer_type||"email"===e.answer_type||"phone"===e.answer_type)for(n=0;e.answers.length>n;n++)(a=i.app.localstorage.load(t.attributes.storage_prefix+"."+e.answers[n].name))&&t.answerCollection.add(new i.models.answer({field:e.answers[n].name,value:a,display:e.answers[n].display,associated_question:e.question_name}));else"radio"!==e.answer_type&&"meal_plan"!==e.answer_type||!(a=i.app.localstorage.load(t.attributes.storage_prefix+"."+e.question_name))?!i.app.localstorage.load(t.attributes.storage_prefix+"."+e.question_name)||"agreement"!==e.answer_type&&"info"!==e.answer_type||t.answerCollection.add(new i.models.answer({field:e.question_name,value:!0,display:e.display,associated_question:e.question_name})):t.answerCollection.add(new i.models.answer({field:e.question_name,value:a,display:e.display,associated_question:e.question_name}))},resetForm:function(){var t=e.post("/api/set/reset_registration");return i.app.$view.fadeOut("slow",function(){i.app.$view.empty(),i.app.localstorage.clear(),t.done(function(){i.app.session={},i.app.paymentProcessingModel.stopPolling(),i.app.attendeeCollection.reset()})}),t}},l.questionsModelCore={defaults:{question_name:"",question:"",answer_type:"text",answers:[],depends_on:{}}},l.questionCollectionCore={},l.attendeeModelCore={defaults:{all_questions_completed:!1,storage_prefix:o,selected:!1},initialize:function(){t.bindAll(this),this.paymentModel=new i.models.payment(o,o,this),this.answerCollection=new i.collections.answer(o,o,this),this.limboAnswerCollection=new i.collections.answer(o,o,this),this.on("change:all_questions_completed",this.save)},getFirstUnansweredQuestion:function(){var t,n=["number_of_attendees","hotel_code_of_conduct"];for(t=0;i.app.questionCollection.length>t;t++)if(-1===e.inArray(i.app.questionCollection.models[t].attributes.question_name,n)&&!this.answerCollection.findWhere({associated_question:i.app.questionCollection.models[t].attributes.question_name})&&this.validateDependencies(i.app.questionCollection.models[t]))return i.app.questionCollection.models[t];return!1},validateDependencies:function(t){var n,a,s,i=t.get("depends_on"),o=t.get("answer_type");if(i.answer_names){if("text"===o||"radio"===o||"info"===o)n=this.answerCollection.findWhere({field:i.question_name});else if("email"===o||"phone"===o)for(a=t.get("answers"),s=0;a.length>s;s++)if(i.question_name=a[s].name){n=this.answerCollection.findWhere({field:a[s].name});break}return n&&-1!==e.inArray(n.get("value"),i.answer_names)?!0:!1}return!0},resetForm:function(){var e,t=this.attributes.storage_prefix;for(e=0;this.answerCollection.length>e;e++)i.app.localstorage.remove(t+"."+this.answerCollection.models[e].attributes.field);this.answerCollection.reset(),this.set("all_questions_completed",!1),i.app.formView.render()},save:function(){i.app.localstorage.save(this.attributes.storage_prefix+"."+"all_questions_completed",!0)}},l.attendeeCollectionCore={initialize:function(){t.bindAll(this),this.on("add",this.selectFirstIncompleteAttendee),this.on("change",this.selectFirstIncompleteAttendee),this.on("change:all_questions_completed",this.fillLimboAnswers)},selectFirstIncompleteAttendee:function(){var e=this.findWhere({all_questions_completed:!1});return e?(i.app.selected.attendee=e,e):!1},fillLimboAnswers:function(){var t,n,a=["last_name","email","phone","address","city","state","zip"],s=this.models[0].answerCollection.toJSON();if(!(2>this.length))for(t=0;s.length>t;t++)if(-1!==e.inArray(s[t].field,a))for(n=1;this.length>n;n++)this.models[n].limboAnswerCollection.add(new i.models.answer(s[t]))}},l.answerModelCore={defaults:{field:"",display:"",value:o,associated_question:""}},l.answerCollectionCore={initialize:function(e,n,a){t.bindAll(this),this.attendeeModel=a}},l.formViewCore={id:"form",events:{"submit form":"processAnswer","click .input-radio":"processAnswer","click .js-meal-plan-select-all":"allMeals","click .js-reset-form":"resetForm","click .js-reset-form-for-attendee":"resetFormForCurrentAttendee","click .js-meal-checkbox":"calculateMealCost"},initialize:function(){t.bindAll(this),i.app.attendeeCollection.on("reset",this.render),i.app.attendeeCollection.on("change",this.render)},render:function(){var e,t;if(0===this.$el.parent().length&&this.$el.appendTo("#view-container"),0===i.app.attendeeCollection.length)t=i.app.selected.question=i.app.questionCollection.findWhere({question_name:"number_of_attendees"});else{if(e=i.app.selected.attendee,!e)return this.renderCheckAnswers(),o;t=i.app.selected.question=e.getFirstUnansweredQuestion()}t?this.renderQuestion(t.toJSON(),e):this.renderCheckAnswers()},renderQuestion:function(e,t){var n,a,s,o=this;if(e[e.answer_type]=!0,t){if(s=t.answerCollection.findWhere({field:"first_name"}))s=s.attributes.value;else for(n=0;i.app.attendeeCollection.length>n;n++)i.app.attendeeCollection.models[n].cid===t.cid&&(s="Attendee #"+(n+1),n=i.app.attendeeCollection.length);for(i.app.attendeeCollection.length>1&&(e.more_than_one_attendee=!0),e.attendee={attendee_name:s},n=0;e.answers.length>n;n++)a=t.limboAnswerCollection.findWhere({field:e.answers[n].name}),a&&(e.answers[n].value=a.attributes.value)}i.app.$view.fadeOut("fast",function(){o.$el.empty().append(i.template("question",e)).find('input[type="text"], input[type="email"], input[type="tel"]').first().focus(),i.app.$view.fadeIn("fast",function(){e.info&&setTimeout(function(){o.$el.find(".info-button").fadeIn("slow")},5e3),t&&t.answerCollection.length>0&&o.$el.find(".extras-container").css("visibility","visible")})})},renderCheckAnswers:function(){this.$el.detach(),i.app.$view.fadeOut("fast",function(){i.app.reviewView.render(),i.app.$view.fadeIn("fast")})},processAnswer:function(){return this.validateAnswer()?this.saveAnswer().render():this.$el.find(".alert").show(),!1},validateAnswer:function(){var e=i.app.selected.question.get("answer_type"),t=function(){return!0},n={number_of_attendees:this.validateNumberOfAttendees,text:this.validateTextAnswers,email:this.validateTextAnswers,phone:this.validatePhone,meal_plan:this.validateMeals,agreement:t,info:t};return n[e]?n[e]():!0},validateNumberOfAttendees:function(){var n,a,s=this.$el.find("input");for(a=0;s.length>a;a++)if(n=parseInt(e.trim(s[a].value),10),!t.isNumber(n)||t.isNaN(n))return e(s[a]).focus(),!1;return!0},validateTextAnswers:function(){var n,a=this.$el.find("input");for(n=0;a.length>n;n++)if(t.isEmpty(e.trim(a[n].value)))return e(a[n]).focus(),!1;return!0},validatePhone:function(){var e=this.$el.find('input[type="tel"]'),t=e.val();return 10!==this.trimPhoneValue(t).length?(e.focus(),!1):!0},validateMeals:function(){var e=this.$el.find(".input-checkbox:checked").filter(function(){return"meal-plan-select-all-checkbox"!==this.id});return 0===e.length?window.confirm("Are you sure you don’t want to register for any meals? (Click OK if you are sure)"):!0},trimPhoneValue:function(t){var n=e.trim(t);return n=n.replace(/(\()|(\))|(-)|(\.)|(\s)/gi,""),n=""+parseInt(n,10),"1"===n[0]&&(n=n.substring(1)),n},saveAnswer:function(){var e,t=[],n=[],a=i.app.selected.question.get("answer_type"),s=function(){var e=i.app.selected.question;return[{field:e.attributes.question_name,value:!0,display:e.attributes.display,associated_question:e.attributes.question_name}]},o={number_of_attendees:this.generateAttendees,text:this.generateTextAnswers,radio:this.generateRadioAnswers,email:this.generateTextAnswers,phone:this.generatePhoneAnswers,meal_plan:this.generateMealAnswers,agreement:s,info:s},l=i.app.attendeeCollection.findWhere({all_questions_completed:!1});for(o[a]&&(t=o[a]()),e=0;t.length>e;e++)this.addAnswer(t[e],n,l.answerCollection),i.app.localstorage.save(l.attributes.storage_prefix+"."+t[e].field,t[e].value);return l&&l.answerCollection.add(n),this},generateAttendees:function(){var t,n=parseInt(e.trim(this.$el.find("input")[0].value),10);for(t=0;n>t;t++)i.app.attendeeCollection.add(new i.models.attendee({storage_prefix:"attendee_"+t}));return i.app.localstorage.save("number_of_attendees",n),[]},generateTextAnswers:function(){var e,t=this.$el.find("input"),n=[];for(e=0;t.length>e;e++)n.push({field:t[e].name,value:t[e].value,display:i.app.selected.question.get("answers")[e].display,associated_question:i.app.selected.question.get("question_name")});return n},generatePhoneAnswers:function(){var e,t,n=[];for(t=this.$el.find("input"),e=0;t.length>e;e++)n.push({field:t[e].name,value:this.trimPhoneValue(t[e].value),display:i.app.selected.question.get("answers")[e].display,associated_question:i.app.selected.question.get("question_name")});return n},generateRadioAnswers:function(){var e=this.$el.find("input:checked"),n=t.find(i.app.selected.question.get("answers"),function(t){return t.name===e.val()}),a=i.app.selected.question.get("question_name"),s=i.app.selected.question.get("display");return[{field:a,value:n.name,display:s,associated_question:a}]},generateMealAnswers:function(){var e,t,n=i.app.selected.question.get("question_name"),a=this.$el.find(".input-checkbox:checked").filter(function(){return"meal-plan-select-all-checkbox"!==this.id}),s={meal_plan_day_1:{dinner:!1},meal_plan_day_2:{breakfast:!1,lunch:!1,dinner:!1},meal_plan_day_3:{breakfast:!1,lunch:!1,dinner:!1},meal_plan_day_4:{breakfast:!1,lunch:!1,dinner:!1},meal_plan_day_5:{breakfast:!1,lunch:!1}};for(t=0;a.length>t;t++)e=a[t].name.split("_"),s["meal_plan_day_"+e[3]][e[4]]=!0;return[{field:n,value:JSON.stringify(s),display:i.app.selected.question.get("display"),associated_question:n}]},addAnswer:function(e,t,n){var a;(a=n.findWhere({field:e.field}))?a.set("value",e.value):t.push(new i.models.answer(e))},allMeals:function(t){var n=e(t.currentTarget),a=this.$el.find(".js-meal-checkbox");return a.prop("checked",n.is(":checked")),this.calculateMealCost(),!0},resetForm:function(){return i.app.resetForm(),!1},resetFormForCurrentAttendee:function(){i.app.selected.attendee.resetForm()},calculateMealCost:function(){var t,n=this.$el.find(".js-meal-checkbox:checked"),a={breakfast:"addBreakfast",lunch:"addLunch",dinner:"addDinner"};for(i.app.selected.attendee.paymentModel.resetCosts(),t=0;n.length>t;t++)i.app.selected.attendee.paymentModel[a[e(n[t]).data("type")]]();this.$el.find(".meal-cost-container").css("visibility","visible").find(".meal-cost").empty().append(i.app.selected.attendee.paymentModel.get("total_cost"))}},l.reviewViewCore={className:"answers",events:{"click .js-correct":"processForm","click .js-reset-form":"resetForm","click .js-reset-form-for-attendee":"resetFormForCurrentAttendee"},initialize:function(){t.bindAll(this)},render:function(){return i.app.attendeeCollection.findWhere({all_questions_completed:!1})?(this.$el.empty().append(i.template("answers",this.generateTemplateVars())),0===this.$el.parent().length&&this.$el.appendTo("#view-container"),o):(i.app.$view.fadeOut("fast",function(){i.app.paymentView.render(),i.app.$view.fadeIn("fast")}),o)},resetForm:function(){var e=this;return i.app.resetForm().done(function(){e.$el.detach().empty()}),!1},resetFormForCurrentAttendee:function(){i.app.selected.attendee.resetForm()},processForm:function(){return i.app.selected.attendee.set("all_questions_completed",!0),this.$el.detach().empty(),!1},generateTemplateVars:function(){var e,n,a,s=i.app.selected.attendee.answerCollection.toJSON(),o=i.app.questionCollection.toJSON(),l=function(t){return t.question_name===e.associated_question},r=function(e){return{display:e.display,value:e.value}},d={text:r,email:r,phone:r,radio:this.generateRadioAnswer,meal_plan:this.generateMealAnswer},p={answers:[],more_than_one_attendee:i.app.attendeeCollection.length>1,attendee:{attendee_name:i.app.selected.attendee.answerCollection.findWhere({field:"first_name"}).attributes.value}};for(n=0;s.length>n;n++)e=s[n],a=t.find(o,l),d[a.answer_type]&&p.answers.push(d[a.answer_type](e,a));return p},generateRadioAnswer:function(e,t){var n;for(n=0;t.answers.length>n;n++)if(t.answers[n].name===e.value)return{display:t.display,value:t.answers[n].display}},generateMealAnswer:function(e,t){var n,a,s,i,o=JSON.parse(e.value),l=[];for(n=0;t.answers.length>n;n++)a=o[t.answers[n].name],s=t.answers[n].display+" ("+t.answers[n].date+"): ",i=[],(a.breakfast||a.lunch||a.dinner)&&(a.breakfast&&i.push("breakfast"),a.lunch&&i.push("lunch"),a.dinner&&i.push("dinner"),s+=i.join(", ")+".",l.push(s));return{display:t.display,value:l.join("<br>")}},reset:function(){this.$el.empty()}},l.paymentModelCore={defaults:{registration_cost:0,cost_from_breakfast:0,cost_from_lunch:0,cost_from_dinner:0,total_cost:0},initialize:function(e,n,a){t.bindAll(this),this.attendeeModel=a,this.on("change:cost_from_breakfast",this.calculateTotalCost),this.on("change:cost_from_lunch",this.calculateTotalCost),this.on("change:cost_from_dinner",this.calculateTotalCost),this.on("change:registration_cost",this.calculateTotalCost)},setRegistrationCost:function(){var e,t={early:new Date("Sun Sep 30 2013 23:59:59 GMT-0500 (CDT)").getTime(),regular:new Date("Fri Nov 15 2013 23:59:59 GMT-0500 (CDT)").getTime(),late:new Date("Tue Dec 10 2013 23:59:59 GMT-0500 (CDT)").getTime()},n=Date.now();return e="11"===this.attendeeModel.answerCollection.findWhere({field:"age"}).attributes.value?0:t.early>=n?10:t.regular>=n?15:25,this.set("registration_cost",e),e},addBreakfast:function(){this.set("cost_from_breakfast",this.attributes.cost_from_breakfast+5)},addLunch:function(){this.set("cost_from_lunch",this.attributes.cost_from_lunch+7)},addDinner:function(){this.set("cost_from_dinner",this.attributes.cost_from_dinner+8)},calculateTotalCostFromSavedAnswer:function(){var e=this.attendeeModel.answerCollection.find(function(e){return"meal_plan"===e.attributes.field});return e?(this.resetCosts(),e=JSON.parse(e.attributes.value),e.meal_plan_day_1.dinner&&this.addDinner(),e.meal_plan_day_2.breakfast&&this.addBreakfast(),e.meal_plan_day_2.lunch&&this.addLunch(),e.meal_plan_day_2.dinner&&this.addDinner(),e.meal_plan_day_3.breakfast&&this.addBreakfast(),e.meal_plan_day_3.lunch&&this.addLunch(),e.meal_plan_day_3.dinner&&this.addDinner(),e.meal_plan_day_4.breakfast&&this.addBreakfast(),e.meal_plan_day_4.lunch&&this.addLunch(),e.meal_plan_day_4.dinner&&this.addDinner(),e.meal_plan_day_5.breakfast&&this.addBreakfast(),e.meal_plan_day_5.lunch&&this.addLunch(),o):!1},calculateTotalCost:function(){this.set("total_cost",this.attributes.registration_cost+this.attributes.cost_from_breakfast+this.attributes.cost_from_lunch+this.attributes.cost_from_dinner)},resetCosts:function(){this.set({cost_from_breakfast:0,cost_from_lunch:0,cost_from_dinner:0,total_cost:this.attributes.registration_cost})}},l.paymentViewCore={events:{"click .js-pay":"proceedWithPayment","click .js-reset-form":"resetForm"},initialize:function(){t.bindAll(this)},render:function(){var e=this.generatePaymentTemplateVars();this.$el.empty().append(i.template("payment",e)),0===this.$el.parent().length&&this.$el.appendTo("#view-container")},generatePaymentTemplateVars:function(){var e,t,n,a,s,o,l={attendees:[],total_cost:0,more_than_one_attendee:i.app.attendeeCollection.length>1},r=i.app.questionCollection.findWhere({question_name:"meal_plan"}).attributes.answers;for(s=0;i.app.attendeeCollection.length>s;s++){for(t=[],n=[],a=[],l.attendees.push({name:i.app.attendeeCollection.models[s].answerCollection.findWhere({field:"first_name"}).attributes.value+" "+i.app.attendeeCollection.models[s].answerCollection.findWhere({field:"last_name"}).attributes.value}),e=JSON.parse(i.app.attendeeCollection.models[s].answerCollection.findWhere({field:"meal_plan"}).attributes.value),l.attendees[s].registration_cost=i.app.attendeeCollection.models[s].paymentModel.setRegistrationCost(),i.app.attendeeCollection.models[s].paymentModel.calculateTotalCostFromSavedAnswer(),o=0;r.length>o;o++)e[r[o].name].breakfast&&t.push(r[o].display),e[r[o].name].lunch&&n.push(r[o].display),e[r[o].name].dinner&&a.push(r[o].display);l.attendees[s].total_meal_cost=i.app.attendeeCollection.models[s].paymentModel.attributes.cost_from_breakfast+i.app.attendeeCollection.models[s].paymentModel.attributes.cost_from_lunch+i.app.attendeeCollection.models[s].paymentModel.attributes.cost_from_dinner,l.attendees[s].breakfast_cost=i.app.attendeeCollection.models[s].paymentModel.attributes.cost_from_breakfast,l.attendees[s].lunch_cost=i.app.attendeeCollection.models[s].paymentModel.attributes.cost_from_lunch,l.attendees[s].dinner_cost=i.app.attendeeCollection.models[s].paymentModel.attributes.cost_from_dinner,l.attendees[s].breakfast_days=t.join(", ")||!1,l.attendees[s].lunch_days=n.join(", ")||!1,l.attendees[s].dinner_days=a.join(", ")||!1,l.attendees[s].total_cost=i.app.attendeeCollection.models[s].paymentModel.attributes.total_cost,l.total_cost+=i.app.attendeeCollection.models[s].paymentModel.attributes.total_cost}return l},proceedToCompletionWithFreeAttendees:function(){var t=this;return this.$el.addClass("payment-processing"),e.ajax("/api/set/free_attendee_registration/",{data:{value:this.prepareAttendeeAjaxInfo()},timeout:1e4,type:"POST"}).done(function(e){return"success"!==e.status?(t.submissionError(),o):(i.app.completionView.render(),o)}).fail(this.submissionError),!1},proceedWithPayment:function(){return this.$el.addClass("payment-processing"),e.ajax("/api/set/attendee_registration/",{data:{value:this.prepareAttendeeAjaxInfo()},timeout:1e4,type:"POST"}).done(this.openPayment).fail(this.submissionError),i.app.paymentProcessingModel.paymentWindow=window.open(),!1},prepareAttendeeAjaxInfo:function(){var e,t=[];for(e=0;i.app.attendeeCollection.length>e;e++)t.push({answers:i.app.attendeeCollection.models[e].answerCollection.toJSON(),payment:i.app.attendeeCollection.models[e].paymentModel.toJSON()});return t},openPayment:function(e){return"success"!==e.status?(this.submissionError(),o):(i.app.localstorage.save("attendee_ids",e.attendee_ids),i.app.localstorage.save("invoice",e.invoice),i.app.paymentProcessingModel.initPaymentProcessing(e.payment_url,e.invoice),o)},submissionError:function(){var t=this.$el.find("#error-modal");this.$el.removeClass("payment-processing"),t.find(".btn").on("click",function(){t.modal("hide"),e(this).off("click")}),t.modal()},resetForm:function(){var e=this;return i.app.resetForm().done(function(){e.$el.detach().empty()}),!1}},l.paymentProcessingModelCore={paymentWindow:null,polling:null,initialize:function(){t.bindAll(this)},initPaymentProcessing:function(e,t){this.paymentWindow.location.href=e,this.polling=setInterval(this.ajaxPoll(t),5e3)},finishPaymentProcessing:function(e){e.paid&&(this.stopPolling(),i.app.completionView.render(),i.app.paymentProcessingModel.paymentWindow&&i.app.paymentProcessingModel.paymentWindow.close&&i.app.paymentProcessingModel.paymentWindow.close())},ajaxPoll:function(t){var n=this;return function(){return e.get("/api/get/check_payment_made",{invoice:t}).done(n.finishPaymentProcessing)}},stopPolling:function(){this.polling&&(clearInterval(this.polling),this.polling=null)}},l.completionViewCore={events:{"click .js-restart-form":"resetForm"},initialize:function(){t.bindAll(this)},render:function(){this.$el.empty().append(i.template("completion",{})),0===this.$el.parent().length&&e("#view-container").empty().append(this.el)},resetForm:function(e){var t=this;return e.currentTarget.innerHTML="Resetting questions…",i.app.resetForm().done(function(){t.$el.detach().empty()}),!1}},l.localStorageController=function(){this.save=function(e,t){return a.localstorage?(window.localStorage.setItem(e,t),!0):!1},this.load=function(e){var t;return a.localstorage&&(t=window.localStorage.getItem(e)),t||(t=i.session[e]),t},this.remove=function(e){a.localstorage&&window.localStorage.removeItem(e)},this.clear=function(){return a.localstorage&&window.localStorage.clear(),!1}},i.init(function(){l.init.initialize()})})(jQuery,_,Backbone,Modernizr,tester,gc);