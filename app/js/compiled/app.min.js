/*! grace-conference-registration - v0.1.0 - * Copyright (c) 2013 Kai Yao <ohkaiby@gmail.com>; Licensed  */
(function(e,t,n,r,i,a,o){"use strict";var s=i||{};s.init={initialize:function(){var r;t.bindAll(s.init),a.models.question=n.Model.extend(s.questionsModelCore),a.app.questionCollection=new(n.Collection.extend(s.questionCollectionCore)),a.models.answer=n.Model.extend(s.answerModelCore),a.collections.answer=n.Collection.extend(s.answerCollectionCore),a.models.attendee=n.Model.extend(s.attendeeModelCore),a.app.attendeeCollection=new(n.Collection.extend(s.attendeeCollectionCore)),a.app.formView=new(n.View.extend(s.formViewCore))({collection:a.app.questionCollection}),a.app.reviewView=new(n.View.extend(s.reviewViewCore)),a.models.payment=n.Model.extend(s.paymentModelCore),a.app.paymentView=new(n.View.extend(s.paymentViewCore)),a.models.paymentProcessing=n.Model.extend(s.paymentProcessingModelCore),a.app.paymentProcessingModel=new a.models.paymentProcessing,a.app.completionView=new(n.View.extend(s.completionViewCore)),a.app.localstorage=new s.localStorageController,a.app.selected={},a.app.resetForm=this.resetForm,a.app.$view=e("#view-container"),this.fillQuestions(),this.fillSavedAttendeeAnswers(),(r=a.app.localstorage.load("invoice"))?e.get("/api/get/check_payment_made",{invoice:r}).done(function(e){e.paid?a.app.completionView.render():a.app.formView.render()}):a.app.formView.render()},fillQuestions:function(){var t,n=[{question_name:"number_of_attendees",question:"How many attendees are you registering for Grace 2013?",answer_type:"number_of_attendees",answers:[{name:"number_of_attendees",display:"# of attendees"}]},{question_name:"name",question:"What is your name?",answer_type:"text",answers:[{name:"first_name",display:"First Name"},{name:"last_name",display:"Last Name"}]},{question_name:"age",question:"How old are you?",display:"Age",answer_type:"radio",answers:[{name:"11",display:"11 and under"},{name:"12_17",display:"12 to 17 years old"},{name:"18",display:"18+ years old"}]},{question_name:"exact_age",question:"What is your EXACT age?",display:"Exact Age",answer_type:"text",answers:[{name:"exact_age",display:"Exact Age"}],depends_on:{question_name:"age",answer_names:["11"]}},{question_name:"gender",question:"You are…",display:"Gender",answer_type:"radio",answers:[{name:"male",display:"Male"},{name:"female",display:"Female"}]},{question_name:"grade",question:"What grade are you in?",display:"What grade",answer_type:"radio",answers:[{name:"5th",display:"5th grade"},{name:"6th",display:"6th grade"},{name:"7th",display:"7th grade"},{name:"8th",display:"8th grade"},{name:"freshmen",display:"Freshmen"},{name:"sophomore",display:"Sophomore"},{name:"junior",display:"Junior"},{name:"senior",display:"Senior"},{name:"freshmen_undergrad",display:"Freshmen (College)"},{name:"sophomore_undergrad",display:"Sophomore (College)"},{name:"junior_undergrad",display:"Junior (College)"},{name:"senior_undergrad",display:"Senior (College)"}],depends_on:{question_name:"age",answer_names:["12_17"]}},{question_name:"status",question:"You are… ?",display:"Status",answer_type:"radio",answers:[{name:"high_school_18",display:"In high school"},{name:"undergrad",display:"In college (undergrad)"},{name:"graduate",display:"In college (graduate)"},{name:"single",display:"Single"},{name:"married",display:"Married"}],depends_on:{question_name:"age",answer_names:["18"]}},{question_name:"undergrad_year",question:"What year in undergrad?",display:"College year",answer_type:"radio",answers:[{name:"1st",display:"First year"},{name:"2nd",display:"Second year"},{name:"3rd",display:"Third year"},{name:"4th",display:"Fourth year"},{name:"5th_plus",display:"Fifth+ year"}],depends_on:{question_name:"status",answer_names:["undergrad"]}},{question_name:"email",question:"What is your email?",answer_type:"email",answers:[{name:"email",display:"Email"}]},{question_name:"phone",question:"What’s your phone number?",answer_type:"phone",answers:[{name:"phone",display:"Phone"}]},{question_name:"phone_is_mobile",question:"Is this a cell phone number?",display:"Is cellphone",answer_type:"radio",answers:[{name:"yes",display:"Yes, it’s a cell phone"},{name:"no",display:"No, it’s not a cell phone"}]},{question_name:"address",question:"What is your address?",answer_type:"text",answers:[{name:"address",display:"Address"},{name:"city",display:"City"},{name:"state",display:"State"},{name:"zip",display:"Zip"}]},{question_name:"meal_plan",question:"Select the meals you would like prepared for you.",display:"Meals",answer_type:"meal_plan",answers:[{name:"meal_plan_day_1",display:"Thursday",date:"12/26/2013",meals:{breakfast:!1,lunch:!1,dinner:!0}},{name:"meal_plan_day_2",display:"Friday",date:"12/27/2013",meals:{breakfast:!0,lunch:!0,dinner:!0}},{name:"meal_plan_day_3",display:"Saturday",date:"12/28/2013",meals:{breakfast:!0,lunch:!0,dinner:!0}},{name:"meal_plan_day_4",display:"Sunday",date:"12/29/2013",meals:{breakfast:!0,lunch:!0,dinner:!0}},{name:"meal_plan_day_5",display:"Monday",date:"12/30/2013",meals:{breakfast:!0,lunch:!0,dinner:!1}}]},{question_name:"permission_slip",answer_type:"info",answers:[{html:e(document.createElement("div")).append(a.template("permission_slip")).html()}],depends_on:{question_name:"age",answer_names:["11","12_17"]}},{question_name:"hotel_code_of_conduct",question:"Please read & agree to the Pheasant Run Resort Code of Conduct.",display:"Agreed to Code of Conduct",answer_type:"agreement",answers:[]}];for(t=0;n.length>t;t++)a.app.questionCollection.add(new a.models.question(n[t]))},fillSavedAttendeeAnswers:function(){var e,t,n=a.app.localstorage.load("number_of_attendees");if(!n)return!1;for(e=0;n>e;e++)a.app.attendeeCollection.add(new a.models.attendee({storage_prefix:"attendee_"+e,all_questions_completed:a.app.localstorage.load("attendee_"+e+"."+"all_questions_completed")}));for(e=0;a.app.questionCollection.length>e;e++)for(t=0;a.app.attendeeCollection.length>t;t++)this.fillSavedAnswer(a.app.questionCollection.models[e].attributes,a.app.attendeeCollection.models[t]);a.app.attendeeCollection.fillLimboAnswers()},fillSavedAnswer:function(e,t){var n,r;if("text"===e.answer_type||"email"===e.answer_type||"phone"===e.answer_type)for(n=0;e.answers.length>n;n++)(r=a.app.localstorage.load(t.attributes.storage_prefix+"."+e.answers[n].name))&&t.answerCollection.add(new a.models.answer({field:e.answers[n].name,value:r,display:e.answers[n].display,associated_question:e.question_name}));else"radio"!==e.answer_type&&"meal_plan"!==e.answer_type||!(r=a.app.localstorage.load(t.attributes.storage_prefix+"."+e.question_name))?!a.app.localstorage.load(t.attributes.storage_prefix+"."+e.question_name)||"agreement"!==e.answer_type&&"info"!==e.answer_type||t.answerCollection.add(new a.models.answer({field:e.question_name,value:!0,display:e.display,associated_question:e.question_name})):t.answerCollection.add(new a.models.answer({field:e.question_name,value:r,display:e.display,associated_question:e.question_name}))},resetForm:function(){var t=e.post("/api/set/reset_registration");return a.app.$view.fadeOut("slow",function(){a.app.$view.empty(),a.app.localstorage.clear(),t.done(function(){a.app.session={},a.app.paymentProcessingModel.stopPolling(),a.app.attendeeCollection.reset()})}),t}},s.questionsModelCore={defaults:{question_name:"",question:"",answer_type:"text",answers:[],depends_on:{}}},s.questionCollectionCore={},s.attendeeModelCore={defaults:{all_questions_completed:!1,storage_prefix:o,selected:!1},initialize:function(){t.bindAll(this),this.paymentModel=new a.models.payment(o,o,this),this.answerCollection=new a.collections.answer(o,o,this),this.limboAnswerCollection=new a.collections.answer(o,o,this),this.on("change:all_questions_completed",this.save)},getFirstUnansweredQuestion:function(){var t,n=["number_of_attendees","hotel_code_of_conduct"];for(t=0;a.app.questionCollection.length>t;t++)if(-1===e.inArray(a.app.questionCollection.models[t].attributes.question_name,n)&&!this.answerCollection.findWhere({associated_question:a.app.questionCollection.models[t].attributes.question_name})&&this.validateDependencies(a.app.questionCollection.models[t]))return a.app.questionCollection.models[t];return!1},validateDependencies:function(t){var n,r,i,a=t.get("depends_on"),o=t.get("answer_type");if(a.answer_names){if("text"===o||"radio"===o||"info"===o)n=this.answerCollection.findWhere({field:a.question_name});else if("email"===o||"phone"===o)for(r=t.get("answers"),i=0;r.length>i;i++)if(a.question_name=r[i].name){n=this.answerCollection.findWhere({field:r[i].name});break}return n&&-1!==e.inArray(n.get("value"),a.answer_names)?!0:!1}return!0},resetForm:function(){var e,t=this.attributes.storage_prefix;for(e=0;this.answerCollection.length>e;e++)a.app.localstorage.remove(t+"."+this.answerCollection.models[e].attributes.field);this.answerCollection.reset(),this.set("all_questions_completed",!1),a.app.formView.render()},save:function(){a.app.localstorage.save(this.attributes.storage_prefix+"."+"all_questions_completed",!0)}},s.attendeeCollectionCore={initialize:function(){t.bindAll(this),this.on("add",this.selectFirstIncompleteAttendee),this.on("change",this.selectFirstIncompleteAttendee),this.on("change:all_questions_completed",this.fillLimboAnswers)},selectFirstIncompleteAttendee:function(){var e=this.findWhere({all_questions_completed:!1});return e?(a.app.selected.attendee=e,e):!1},fillLimboAnswers:function(){var t,n,r=["last_name","email","phone","address","city","state","zip"],i=this.models[0].answerCollection.toJSON();if(!(2>this.length))for(t=0;i.length>t;t++)if(-1!==e.inArray(i[t].field,r))for(n=1;this.length>n;n++)this.models[n].limboAnswerCollection.add(new a.models.answer(i[t]))}},s.answerModelCore={defaults:{field:"",display:"",value:o,associated_question:""}},s.answerCollectionCore={initialize:function(e,n,r){t.bindAll(this),this.attendeeModel=r}},s.formViewCore={id:"form",events:{"submit form":"processAnswer","click .input-radio":"processAnswer","click .js-meal-plan-select-all":"allMeals","click .js-reset-form":"resetForm","click .js-reset-form-for-attendee":"resetFormForCurrentAttendee","click .js-meal-checkbox":"calculateMealCost"},initialize:function(){t.bindAll(this),a.app.attendeeCollection.on("reset",this.render),a.app.attendeeCollection.on("change",this.render)},render:function(){var e,t;if(0===this.$el.parent().length&&this.$el.appendTo("#view-container"),0===a.app.attendeeCollection.length)t=a.app.selected.question=a.app.questionCollection.findWhere({question_name:"number_of_attendees"});else{if(e=a.app.selected.attendee,!e)return this.renderCheckAnswers(),o;t=a.app.selected.question=e.getFirstUnansweredQuestion()}t?this.renderQuestion(t.toJSON(),e):this.renderCheckAnswers()},renderQuestion:function(e,t){var n,r,i,o=this;if(e[e.answer_type]=!0,t){if(i=t.answerCollection.findWhere({field:"first_name"}))i=i.attributes.value;else for(n=0;a.app.attendeeCollection.length>n;n++)a.app.attendeeCollection.models[n].cid===t.cid&&(i="Attendee #"+(n+1),n=a.app.attendeeCollection.length);for(a.app.attendeeCollection.length>1&&(e.more_than_one_attendee=!0),e.attendee={attendee_name:i},n=0;e.answers.length>n;n++)r=t.limboAnswerCollection.findWhere({field:e.answers[n].name}),r&&(e.answers[n].value=r.attributes.value)}a.app.$view.fadeOut("fast",function(){o.$el.empty().append(a.template("question",e)).find('input[type="text"], input[type="email"], input[type="tel"]').first().focus(),a.app.$view.fadeIn("fast",function(){e.info&&setTimeout(function(){o.$el.find(".info-button").fadeIn("slow")},5e3),t&&t.answerCollection.length>0&&o.$el.find(".extras-container").css("visibility","visible")})})},renderCheckAnswers:function(){this.$el.detach(),a.app.$view.fadeOut("fast",function(){a.app.reviewView.render(),a.app.$view.fadeIn("fast")})},processAnswer:function(){return this.validateAnswer()?this.saveAnswer().render():this.$el.find(".alert").show(),!1},validateAnswer:function(){var e=a.app.selected.question.get("answer_type"),t=function(){return!0},n={number_of_attendees:this.validateNumberOfAttendees,text:this.validateTextAnswers,email:this.validateTextAnswers,phone:this.validatePhone,meal_plan:this.validateMeals,agreement:t,info:t};return n[e]?n[e]():!0},validateNumberOfAttendees:function(){var n,r,i=this.$el.find("input");for(r=0;i.length>r;r++)if(n=parseInt(e.trim(i[r].value),10),!t.isNumber(n)||t.isNaN(n))return e(i[r]).focus(),!1;return!0},validateTextAnswers:function(){var n,r=this.$el.find("input");for(n=0;r.length>n;n++)if(t.isEmpty(e.trim(r[n].value)))return e(r[n]).focus(),!1;return!0},validatePhone:function(){var e=this.$el.find('input[type="tel"]'),t=e.val();return 10!==this.trimPhoneValue(t).length?(e.focus(),!1):!0},validateMeals:function(){var e=this.$el.find(".input-checkbox:checked").filter(function(){return"meal-plan-select-all-checkbox"!==this.id});return 0===e.length?window.confirm("Are you sure you don’t want to register for any meals? (Click OK if you are sure)"):!0},trimPhoneValue:function(t){var n=e.trim(t);return n=n.replace(/(\()|(\))|(-)|(\.)|(\s)/gi,""),n=""+parseInt(n,10),"1"===n[0]&&(n=n.substring(1)),n},saveAnswer:function(){var e,t=[],n=[],r=a.app.selected.question.get("answer_type"),i=function(){var e=a.app.selected.question;return[{field:e.attributes.question_name,value:!0,display:e.attributes.display,associated_question:e.attributes.question_name}]},o={number_of_attendees:this.generateAttendees,text:this.generateTextAnswers,radio:this.generateRadioAnswers,email:this.generateTextAnswers,phone:this.generatePhoneAnswers,meal_plan:this.generateMealAnswers,agreement:i,info:i},s=a.app.attendeeCollection.findWhere({all_questions_completed:!1});for(o[r]&&(t=o[r]()),e=0;t.length>e;e++)this.addAnswer(t[e],n,s.answerCollection),a.app.localstorage.save(s.attributes.storage_prefix+"."+t[e].field,t[e].value);return s&&s.answerCollection.add(n),this},generateAttendees:function(){var t,n=parseInt(e.trim(this.$el.find("input")[0].value),10);for(t=0;n>t;t++)a.app.attendeeCollection.add(new a.models.attendee({storage_prefix:"attendee_"+t}));return a.app.localstorage.save("number_of_attendees",n),[]},generateTextAnswers:function(){var e,t=this.$el.find("input"),n=[];for(e=0;t.length>e;e++)n.push({field:t[e].name,value:t[e].value,display:a.app.selected.question.get("answers")[e].display,associated_question:a.app.selected.question.get("question_name")});return n},generatePhoneAnswers:function(){var e,t,n=[];for(t=this.$el.find("input"),e=0;t.length>e;e++)n.push({field:t[e].name,value:this.trimPhoneValue(t[e].value),display:a.app.selected.question.get("answers")[e].display,associated_question:a.app.selected.question.get("question_name")});return n},generateRadioAnswers:function(){var e=this.$el.find("input:checked"),n=t.find(a.app.selected.question.get("answers"),function(t){return t.name===e.val()}),r=a.app.selected.question.get("question_name"),i=a.app.selected.question.get("display");return[{field:r,value:n.name,display:i,associated_question:r}]},generateMealAnswers:function(){var e,t,n=a.app.selected.question.get("question_name"),r=this.$el.find(".input-checkbox:checked").filter(function(){return"meal-plan-select-all-checkbox"!==this.id}),i={meal_plan_day_1:{dinner:!1},meal_plan_day_2:{breakfast:!1,lunch:!1,dinner:!1},meal_plan_day_3:{breakfast:!1,lunch:!1,dinner:!1},meal_plan_day_4:{breakfast:!1,lunch:!1,dinner:!1},meal_plan_day_5:{breakfast:!1,lunch:!1}};for(t=0;r.length>t;t++)e=r[t].name.split("_"),i["meal_plan_day_"+e[3]][e[4]]=!0;return[{field:n,value:JSON.stringify(i),display:a.app.selected.question.get("display"),associated_question:n}]},addAnswer:function(e,t,n){var r;(r=n.findWhere({field:e.field}))?r.set("value",e.value):t.push(new a.models.answer(e))},allMeals:function(t){var n=e(t.currentTarget),r=this.$el.find(".js-meal-checkbox");return r.prop("checked",n.is(":checked")),this.calculateMealCost(),!0},resetForm:function(){return a.app.resetForm(),!1},resetFormForCurrentAttendee:function(){a.app.selected.attendee.resetForm()},calculateMealCost:function(){var t,n=this.$el.find(".js-meal-checkbox:checked"),r={breakfast:"addBreakfast",lunch:"addLunch",dinner:"addDinner"};for(a.app.selected.attendee.paymentModel.resetCosts(),t=0;n.length>t;t++)a.app.selected.attendee.paymentModel[r[e(n[t]).data("type")]]();this.$el.find(".meal-cost-container").css("visibility","visible").find(".meal-cost").empty().append(a.app.selected.attendee.paymentModel.get("total_cost"))}},s.reviewViewCore={className:"answers",events:{"click .js-correct":"processForm","click .js-reset-form":"resetForm","click .js-reset-form-for-attendee":"resetFormForCurrentAttendee"},initialize:function(){t.bindAll(this)},render:function(){return a.app.attendeeCollection.findWhere({all_questions_completed:!1})?(this.$el.empty().append(a.template("answers",this.generateTemplateVars())),0===this.$el.parent().length&&this.$el.appendTo("#view-container"),o):(a.app.$view.fadeOut("fast",function(){a.app.paymentView.render(),a.app.$view.fadeIn("fast")}),o)},resetForm:function(){var e=this;return a.app.resetForm().done(function(){e.$el.detach().empty()}),!1},resetFormForCurrentAttendee:function(){a.app.selected.attendee.resetForm()},processForm:function(){return a.app.selected.attendee.set("all_questions_completed",!0),this.$el.detach().empty(),!1},generateTemplateVars:function(){var e,n,r,i=a.app.selected.attendee.answerCollection.toJSON(),o=a.app.questionCollection.toJSON(),s=function(t){return t.question_name===e.associated_question},l=function(e){return{display:e.display,value:e.value}},u={text:l,email:l,phone:l,radio:this.generateRadioAnswer,meal_plan:this.generateMealAnswer},c={answers:[],more_than_one_attendee:a.app.attendeeCollection.length>1,attendee:{attendee_name:a.app.selected.attendee.answerCollection.findWhere({field:"first_name"}).attributes.value}};for(n=0;i.length>n;n++)e=i[n],r=t.find(o,s),u[r.answer_type]&&c.answers.push(u[r.answer_type](e,r));return c},generateRadioAnswer:function(e,t){var n;for(n=0;t.answers.length>n;n++)if(t.answers[n].name===e.value)return{display:t.display,value:t.answers[n].display}},generateMealAnswer:function(e,t){var n,r,i,a,o=JSON.parse(e.value),s=[];for(n=0;t.answers.length>n;n++)r=o[t.answers[n].name],i=t.answers[n].display+" ("+t.answers[n].date+"): ",a=[],(r.breakfast||r.lunch||r.dinner)&&(r.breakfast&&a.push("breakfast"),r.lunch&&a.push("lunch"),r.dinner&&a.push("dinner"),i+=a.join(", ")+".",s.push(i));return{display:t.display,value:s.join("<br>")}},reset:function(){this.$el.empty()}},s.paymentModelCore={defaults:{registration_cost:0,cost_from_breakfast:0,cost_from_lunch:0,cost_from_dinner:0,total_cost:0},initialize:function(e,n,r){t.bindAll(this),this.attendeeModel=r,this.on("change:cost_from_breakfast",this.calculateTotalCost),this.on("change:cost_from_lunch",this.calculateTotalCost),this.on("change:cost_from_dinner",this.calculateTotalCost),this.on("change:registration_cost",this.calculateTotalCost)},setRegistrationCost:function(){var e,t={early:new Date("Sun Sep 30 2013 23:59:59 GMT-0500 (CDT)").getTime(),regular:new Date("Fri Nov 15 2013 23:59:59 GMT-0500 (CDT)").getTime(),late:new Date("Tue Dec 10 2013 23:59:59 GMT-0500 (CDT)").getTime()},n=(new Date).getTime();return e="11"===this.attendeeModel.answerCollection.findWhere({field:"age"}).attributes.value?0:t.early>=n?10:t.regular>=n?15:25,this.set("registration_cost",e),e},addBreakfast:function(){this.set("cost_from_breakfast",this.attributes.cost_from_breakfast+5)},addLunch:function(){this.set("cost_from_lunch",this.attributes.cost_from_lunch+7)},addDinner:function(){this.set("cost_from_dinner",this.attributes.cost_from_dinner+8)},calculateTotalCostFromSavedAnswer:function(){var e=this.attendeeModel.answerCollection.find(function(e){return"meal_plan"===e.attributes.field});return e?(this.resetCosts(),e=JSON.parse(e.attributes.value),e.meal_plan_day_1.dinner&&this.addDinner(),e.meal_plan_day_2.breakfast&&this.addBreakfast(),e.meal_plan_day_2.lunch&&this.addLunch(),e.meal_plan_day_2.dinner&&this.addDinner(),e.meal_plan_day_3.breakfast&&this.addBreakfast(),e.meal_plan_day_3.lunch&&this.addLunch(),e.meal_plan_day_3.dinner&&this.addDinner(),e.meal_plan_day_4.breakfast&&this.addBreakfast(),e.meal_plan_day_4.lunch&&this.addLunch(),e.meal_plan_day_4.dinner&&this.addDinner(),e.meal_plan_day_5.breakfast&&this.addBreakfast(),e.meal_plan_day_5.lunch&&this.addLunch(),o):!1},calculateTotalCost:function(){this.set("total_cost",this.attributes.registration_cost+this.attributes.cost_from_breakfast+this.attributes.cost_from_lunch+this.attributes.cost_from_dinner)},resetCosts:function(){this.set({cost_from_breakfast:0,cost_from_lunch:0,cost_from_dinner:0,total_cost:this.attributes.registration_cost})}},s.paymentViewCore={events:{"click .js-pay":"proceedWithPayment","click .js-reset-form":"resetForm"},initialize:function(){t.bindAll(this)},render:function(){var e=this.generatePaymentTemplateVars();this.$el.empty().append(a.template("payment",e)),0===this.$el.parent().length&&this.$el.appendTo("#view-container")},generatePaymentTemplateVars:function(){var e,t,n,r,i,o,s={attendees:[],total_cost:0,more_than_one_attendee:a.app.attendeeCollection.length>1},l=a.app.questionCollection.findWhere({question_name:"meal_plan"}).attributes.answers;for(i=0;a.app.attendeeCollection.length>i;i++){for(t=[],n=[],r=[],s.attendees.push({name:a.app.attendeeCollection.models[i].answerCollection.findWhere({field:"first_name"}).attributes.value+" "+a.app.attendeeCollection.models[i].answerCollection.findWhere({field:"last_name"}).attributes.value}),e=JSON.parse(a.app.attendeeCollection.models[i].answerCollection.findWhere({field:"meal_plan"}).attributes.value),s.attendees[i].registration_cost=a.app.attendeeCollection.models[i].paymentModel.setRegistrationCost(),a.app.attendeeCollection.models[i].paymentModel.calculateTotalCostFromSavedAnswer(),o=0;l.length>o;o++)e[l[o].name].breakfast&&t.push(l[o].display),e[l[o].name].lunch&&n.push(l[o].display),e[l[o].name].dinner&&r.push(l[o].display);s.attendees[i].total_meal_cost=a.app.attendeeCollection.models[i].paymentModel.attributes.cost_from_breakfast+a.app.attendeeCollection.models[i].paymentModel.attributes.cost_from_lunch+a.app.attendeeCollection.models[i].paymentModel.attributes.cost_from_dinner,s.attendees[i].breakfast_cost=a.app.attendeeCollection.models[i].paymentModel.attributes.cost_from_breakfast,s.attendees[i].lunch_cost=a.app.attendeeCollection.models[i].paymentModel.attributes.cost_from_lunch,s.attendees[i].dinner_cost=a.app.attendeeCollection.models[i].paymentModel.attributes.cost_from_dinner,s.attendees[i].breakfast_days=t.join(", ")||!1,s.attendees[i].lunch_days=n.join(", ")||!1,s.attendees[i].dinner_days=r.join(", ")||!1,s.attendees[i].total_cost=a.app.attendeeCollection.models[i].paymentModel.attributes.total_cost,s.total_cost+=a.app.attendeeCollection.models[i].paymentModel.attributes.total_cost}return s},proceedToCompletionWithFreeAttendees:function(){var t=this;return this.$el.addClass("payment-processing"),e.ajax("/api/set/free_attendee_registration/",{data:{value:this.prepareAttendeeAjaxInfo()},timeout:1e4,type:"POST"}).done(function(e){return"success"!==e.status?(t.submissionError(),o):(a.app.completionView.render(),o)}).fail(this.submissionError),!1},proceedWithPayment:function(){return this.$el.addClass("payment-processing"),e.ajax("/api/set/attendee_registration/",{data:{value:this.prepareAttendeeAjaxInfo()},timeout:1e4,type:"POST"}).done(this.openPayment).fail(this.submissionError),a.app.paymentProcessingModel.paymentWindow=window.open(),!1},prepareAttendeeAjaxInfo:function(){var e,t=[];for(e=0;a.app.attendeeCollection.length>e;e++)t.push({answers:a.app.attendeeCollection.models[e].answerCollection.toJSON(),payment:a.app.attendeeCollection.models[e].paymentModel.toJSON()});return t},openPayment:function(e){return"success"!==e.status?(this.submissionError(),o):(a.app.localstorage.save("attendee_ids",e.attendee_ids),a.app.localstorage.save("invoice",e.invoice),a.app.paymentProcessingModel.initPaymentProcessing(e.payment_url,e.invoice),o)},submissionError:function(){var t=this.$el.find("#error-modal");this.$el.removeClass("payment-processing"),t.find(".btn").on("click",function(){t.modal("hide"),e(this).off("click")}),t.modal()},resetForm:function(){var e=this;return a.app.resetForm().done(function(){e.$el.detach().empty()}),!1}},s.paymentProcessingModelCore={paymentWindow:null,polling:null,initialize:function(){t.bindAll(this)},initPaymentProcessing:function(e,t){this.paymentWindow.location.href=e,this.polling=setInterval(this.ajaxPoll(t),5e3)},finishPaymentProcessing:function(e){e.paid&&(this.stopPolling(),a.app.completionView.render(),a.app.paymentProcessingModel.paymentWindow&&a.app.paymentProcessingModel.paymentWindow.close&&a.app.paymentProcessingModel.paymentWindow.close())},ajaxPoll:function(t){var n=this;return function(){return e.get("/api/get/check_payment_made",{invoice:t}).done(n.finishPaymentProcessing)}},stopPolling:function(){this.polling&&(clearInterval(this.polling),this.polling=null)}},s.completionViewCore={events:{"click .js-restart-form":"resetForm"},initialize:function(){t.bindAll(this)},render:function(){this.$el.empty().append(a.template("completion",{})),0===this.$el.parent().length&&e("#view-container").empty().append(this.el)},resetForm:function(e){var t=this;return e.currentTarget.innerHTML="Resetting questions…",a.app.resetForm().done(function(){t.$el.detach().empty()}),!1}},s.localStorageController=function(){this.save=function(e,t){return r.localstorage?(window.localStorage.setItem(e,t),!0):!1},this.load=function(e){var t;return r.localstorage&&(t=window.localStorage.getItem(e)),t||(t=a.session[e]),t},this.remove=function(e){r.localstorage&&window.localStorage.removeItem(e)},this.clear=function(){return r.localstorage&&window.localStorage.clear(),!1}},a.init(function(){s.init.initialize()})})(jQuery,_,Backbone,Modernizr,tester,gc);